{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Production deploy of Sample Transport Tracking",

  "Parameters": {
    "KeyName": {
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance.  If you don't have one, create one first.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription" : "Must be the name of an existing EC2 KeyPair."
    },    
    "DBUser": {
      "Description" : "The database admin account username",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription" : "must begin with a letter and contain only alphanumeric characters."
    },
    "DBPassword": {
      "NoEcho": "true",
      "Description" : "The database admin account password",
      "Type": "String",
      "MinLength": "8",
      "MaxLength": "41",
      "AllowedPattern" : "[a-zA-Z0-9]*",
      "ConstraintDescription" : "must contain only alphanumeric characters and be between 8 and 41 characters long."
    }
  },

  "Resources" : {
    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription": "Open database for access",
        "SecurityGroupIngress" : [{
          "IpProtocol" : "tcp",
          "FromPort" : "3306", 
          "ToPort" : "3306",
          "SourceSecurityGroupName" : { "Ref" : "InstanceSecurityGroup" }
        }]
      }
    },
    "MainDB" : {
      "Type" : "AWS::RDS::DBInstance",
      "Properties" : {
        "DBName" : "odk_stt",
        "AllocatedStorage" : "5",
        "DBInstanceClass" : "db.t2.micro",
        "Engine" : "MySQL",
        "EngineVersion" : "5.7",
        "MasterUsername" : { "Ref" : "DBUser" },
        "MasterUserPassword" : { "Ref" : "DBPassword" },
				"VPCSecurityGroups" : [{ "Fn::GetAtt": [ "DBSecurityGroup", "GroupId" ] }]
      }
    },
		"Ec2Instance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : "ami-0d77397e",
        "KeyName" : { "Ref" : "KeyName" },
				"InstanceType" : "t2.micro",
				"SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
        "Tags": [{
          "Key" : "Name",
          "Value" : "STT server"
        }],
				"UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
					"#!/bin/bash \n",
          "echo \"",
          "MYSQL_USER=", { "Ref" : "DBUser"}, "\n",
          "MYSQL_DATABASE=", "odk_stt", "\n",
          "MYSQL_PASSWORD=", { "Ref" : "DBPassword"}, "\n",
          "DB_CONTAINER_NAME=", { "Fn::GetAtt": [ "MainDB", "Endpoint.Address" ] }, "\n",
          "STT_DB_USER=", { "Ref" : "DBUser"}, "\n",
          "STT_DB_PASSWORD=", { "Ref" : "DBPassword" }, "\n",
          "STT_DB_NAME=stt\n",
          "STT_DB_HOST=", { "Fn::GetAtt": [ "MainDB", "Endpoint.Address" ] }, "\n",
          "STT_DB_PORT=", { "Fn::GetAtt": [ "MainDB", "Endpoint.Port" ] }, "\n",
          "\" > /etc/stt_creds\n"
				]]}}
      }
    },
    "InstanceSecurityGroup" : {
       "Type" : "AWS::EC2::SecurityGroup",
       "Properties" : {
          "GroupDescription" : "Allow http to client host",
          "SecurityGroupIngress" : [{
                "IpProtocol" : "tcp",
                "FromPort" : "80",
                "ToPort" : "80",
                "CidrIp" : "0.0.0.0/0"
             },{
                "IpProtocol" : "tcp",
                "FromPort" : "443",
                "ToPort" : "443",
                "CidrIp" : "0.0.0.0/0"
             },{
                "IpProtocol" : "tcp",
                "FromPort" : "22",
                "ToPort" : "22",
                "CidrIp" : "0.0.0.0/0"
             }]
       }
    },
    "MyEIP" : {
     "Type" : "AWS::EC2::EIP",
     "Properties" : {
         "InstanceId" : { "Ref" : "Ec2Instance" }
     }
    }
  },

  "Outputs" : {
    "JDBCConnectionString": {
      "Description" : "JDBC connection string for the database",
      "Value" : { "Fn::Join": [ "", [ "jdbc:mysql://",
                                      { "Fn::GetAtt": [ "MainDB", "Endpoint.Address" ] },
                                      ":",
                                      { "Fn::GetAtt": [ "MainDB", "Endpoint.Port" ] },
                                      "/",
                                      "odk_stt"]]}
    }
  }
}

